{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block body %}
  <div class="grid grid-cols-2 md:grid-cols-4 auto-rows-min md:grid-rows-4 gap-4 p-6 md:h-screen">
    
    <!-- User Info -->
    <div class="col-span-2 md:col-start-3 md:col-span-2 md:row-start-1 flex gap-2 flex-col sm:flex-row">
      <img src="{{ user.images[0].url }}" alt="Profile" class="rounded-full hidden md:inline">
      <div>
        <h1 class="text-3xl font-bold">Welcome, {{ user.display_name }}!</h1>
        <p class="text-gray-400 text-sm">Email: {{ user.email }}</p>
        <a href="/logout" class="text-green-500 font-bold text-sm">Logout</a>
      </div>
    </div>

    <!-- summarized data (listening time, favorite song(?))-->
    <div class="col-span-1 md:row-start-4 md:col-start-3 flex flex-col items-center justify-center md:h-full">
      <p class="text-sm text-green-500 font-bold">Favorite Genre</p>
      <h2 class="text-3xl font-bold">{{ top_genres[0][0] }}</h2>
    </div>
    <div class="col-span-1 md:row-start-4 md:col-start-4 flex flex-col items-center justify-center md:h-full">
      <p class="text-sm text-green-500 font-bold">Average Track Popularity</p>
      <h2 class="text-3xl font-bold">{{ (top_tracks | sum(attribute='popularity') / top_tracks | length) | round }}%</h2>
    </div>

    <!-- Bar Chart -->
    <div class="col-span-2 md:col-start-1 md:row-start-1 md:col-span-2 md:row-span-2 flex flex-col items-center justify-center h-full">      
      <canvas id="genresBarChart"></canvas>
    </div>

    <!-- Top Tracks -->
     <div class="col-span-2 md:row-start-2 md:col-start-3 md:row-span-2 md:col-span-2">
      <h2 class="text-3xl font-bold">Top Tracks</h2>
      <ul class="mt-4">
        {% for track in top_tracks %}
          <li class="flex items-center gap-2 mb-2">
            <img src="{{ track.album.images[0].url }}" alt="Cover" class="w-10 h-10 rounded shadow">
            <p>{{ track.name }} by {{ track.artists[0].name }}</p>
          </li>
        {% endfor %}
      </ul>
     </div>

    <!-- Top Artists -->
    <div class="col-span-2 md:row-start-3 md:col-start-1 md:row-span-2 md:col-span-2 overflow-hidden">
      <h2 class="text-3xl font-bold">Top Artists</h2>
      <div class="flex">
      {% for artist in top_artists %}
        <div class="flex flex-col items-center grow flex-1">
        <img src="{{ artist.images[0].url }}" alt="{{ artist.name }}" class="aspect-square w-30 object-cover rounded-full shadow mb-2">
        <span class="text-md text-center font-semibold">{{ artist.name }}</span>
        </div>
      {% endfor %}
      </div>
    </div>
    
  </div>
  




    <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    {% if top_genres %}
    // Prepare data for radar chart
    const genresData = {{ top_genres | tojson }};
    const labels = genresData.map(item => item[0]); // Genre names
    const data = genresData.map(item => item[1]);   // Counts
    
    // Create bar chart
    const ctx = document.getElementById('genresBarChart').getContext('2d');
    const barChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Genre Frequency',
          data: data,
          backgroundColor: 'rgba(34, 197, 94, 1)',
          borderColor: 'rgba(34, 197, 94, 1)',
          borderWidth: 0,
          borderRadius: 8,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            enabled: false
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#ffffff',
              font: {
                size: 12,
                weight: 'bold'
              }
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.1)',
              drawBorder: false,
              display: false
            }
          },
          y: {
            beginAtZero: true,
            max: Math.max(...data) + 1,
            ticks: {
              stepSize: 1,
              color: '#ffffff',
              font: {
                size: 11
              },
              display: false
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.2)',
              drawBorder: false,
              display: false
            },
            border: {
              display: false
            }
          }
        },
        layout: {
          padding: {
            top: 10,
            bottom: 10,
            left: 10,
            right: 10
          }
        }
      }
    });
    {% endif %}
  </script>

{% endblock %}